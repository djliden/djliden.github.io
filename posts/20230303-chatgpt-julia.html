<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Using the ChatGPT API with Julia Part 1: the HTTP.jl Library</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<link rel="stylesheet" type="text/css" href="/orgstyle.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap" rel="stylesheet">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@dliden">
</head>
<body>
<div id="preamble" class="status">
<hr style="border-top: 1px solid black;">
<div class='topnav' style='display: flex; justify-content: space-between; align-items: center;'>
  <a href="/index.html"><h2 style='margin-top: 0; margin-bottom: 0; margin-left:0px;'>Daniel Liden</h2></a>
  <div>
    <a href='/archive.html' style='font-weight:bold; font-style:italic;'>Blog</a> / 
    <a href='/about.html' style='font-weight:bold; font-style:italic;'>About Me</a> /
    <a href='/photos.html' style='font-weight:bold; font-style:italic;'>Photos</a> /
    <a href='/notebooks/' style='font-weight:bold; font-style:italic;'>Notebooks</a> /
    <a href='/notes.html' style='font-weight:bold; font-style:italic;'>Notes</a> /
    <a href='/rss.xml'>
      <img src='/rss.png' style='height: 1em;'>
    </a>
  </div>
</div>
<hr style="border-top: 1px solid black;">
</div>
<div id="content" class="content">
<header>
<h1 class="title">Using the ChatGPT API with Julia Part 1: the HTTP.jl Library</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgfe1ba13">Introduction</a></li>
<li><a href="#orgd059092">curl Example</a></li>
<li><a href="#org5d5220e">Julia example</a></li>
<li><a href="#orgc79ed10">A little more detail about sending messages</a></li>
<li><a href="#orgfa5d55e">Next Up&#x2026;</a></li>
</ul>
</div>
</nav>

<div id="outline-container-orgfe1ba13" class="outline-2">
<h2 id="orgfe1ba13">Introduction</h2>
<div class="outline-text-2" id="text-orgfe1ba13">
<div class="preview" id="org31d9551">
<p>
This brief post shows the basics of using the Julia <code>HTTP</code> library to interact
with the OpenAI ChatGPT API, which was made public a few days ago. This post
will only include the minimum necessary detail for getting started with the
API. Future posts will go into a little more detail on how to send message
histories and engage more interactively with the API.
</p>

</div>
</div>
</div>
<div id="outline-container-orgd059092" class="outline-2">
<h2 id="orgd059092">curl Example</h2>
<div class="outline-text-2" id="text-orgd059092">
<p>
<a href="https://platform.openai.com/docs/api-reference/chat/create">Here</a> is the API documentation on OpenAI's website. An example request with <code>curl</code>
looks like this:
</p>

<div class="org-src-container">
<pre class="src src-bash">curl https://api.openai.com/v1/chat/completions <span class="org-sh-escaped-newline">\</span>
  -H <span class="org-string">'Content-Type: application/json'</span> <span class="org-sh-escaped-newline">\</span>
  -H <span class="org-string">'Authorization: Bearer YOUR_API_KEY'</span> <span class="org-sh-escaped-newline">\</span>
  -d <span class="org-string">'{</span>
<span class="org-string">  "model": "gpt-3.5-turbo",</span>
<span class="org-string">  "messages": [{"role": "user", "content": "Hello!"}]</span>
<span class="org-string">}'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d5220e" class="outline-2">
<h2 id="org5d5220e">Julia example</h2>
<div class="outline-text-2" id="text-org5d5220e">
<p>
And here's how we can re-create this with the Julia HTTP library:
</p>

<div class="org-src-container">
<pre class="src src-julia">OPENAI_API_KEY = ENV[<span class="org-string">"OPENAI_API_KEY"</span>]

<span class="org-keyword">using</span> HTTP
<span class="org-keyword">using</span> JSON

headers = HTTP.Headers([
    <span class="org-string">"Authorization"</span> =&gt; <span class="org-string">"Bearer $OPENAI_API_KEY"</span>,
    <span class="org-string">"Content-Type"</span> =&gt; <span class="org-string">"application/json"</span>,
])

body = json(Dict(<span class="org-string">"model"</span> =&gt; <span class="org-string">"gpt-3.5-turbo"</span>,
                 <span class="org-string">"messages"</span> =&gt; [Dict(<span class="org-string">"role"</span> =&gt; <span class="org-string">"user"</span>, <span class="org-string">"content"</span> =&gt; <span class="org-string">"Hello!"</span>)]))


response = HTTP.post(
    <span class="org-string">"https://api.openai.com/v1/chat/completions"</span>,
    headers,
    body;
    verbose = <span class="org-constant">false</span>,
)

<span class="org-comment-delimiter"># </span><span class="org-comment">Parse the response body as JSON</span>
result = JSON.parse(String(response.body))
print(result)
</pre>
</div>

<pre class="example">
Dict{String, Any}("choices" =&gt; Any[Dict{String, Any}("finish_reason" =&gt; "stop", "message" =&gt; Dict{String, Any}("role" =&gt; "assistant", "content" =&gt; "\n\nHello there! How may I be of assistance?"), "index" =&gt; 0)], "model" =&gt; "gpt-3.5-turbo-0301", "usage" =&gt; Dict{String, Any}("completion_tokens" =&gt; 12, "total_tokens" =&gt; 21, "prompt_tokens" =&gt; 9), "id" =&gt; "chatcmpl-6qMM6OmdVRZ8VtdKgKFtb7aRDYWkF", "object" =&gt; "chat.completion", "created" =&gt; 1677937010)
</pre>


<p>
Note that <code>OPENAI_API_KEY</code> is stored as an environment variable on my system, so I
was able to access it with <code>OPENAI_API_KEY = ENV["OPENAI_API_KEY"]</code>.
</p>

<p>
We can extract the completion itself from the "choices" dictionary entry.
</p>

<div class="org-src-container">
<pre class="src src-julia">chat_response = result[<span class="org-string">"choices"</span>]
chat_response[1][<span class="org-string">"message"</span>][<span class="org-string">"content"</span>]
</pre>
</div>

<pre class="example">
"\n\nHello there! How may I be of assistance?"
</pre>
</div>
</div>
<div id="outline-container-orgc79ed10" class="outline-2">
<h2 id="orgc79ed10">A little more detail about sending messages</h2>
<div class="outline-text-2" id="text-orgc79ed10">
<p>
One of the things that makes ChatGPT useful is its ability to "remember" past
parts of a conversation. We can send whole conversations to the API using the
"messages" part of the request body. <code>messages</code> is an array of ~Dict~s, each of
which has a "role" and a "content." There are three options for "role":
</p>
<ol class="org-ol">
<li><code>system</code>: sets the behavior of the assistant. The <code>content</code> might be, for
example, <code>you are a helpful assistant</code> or <code>you are a very polite customer
   support agent</code> or <code>you are a senior software engineer in a mentorship role</code>.</li>
<li><code>user</code>: The human interacting with ChatGPT.</li>
<li><code>assistant</code>: the responses from ChatGPT</li>
</ol>

<p>
So we can send a more complete conversation and get some richer details in
response. For example:
</p>

<div class="org-src-container">
<pre class="src src-julia">messages=[Dict(<span class="org-string">"role"</span> =&gt; <span class="org-string">"system"</span>, <span class="org-string">"content"</span> =&gt; <span class="org-string">"You are a knowledgable and helpful Julia developer."</span>),
         Dict(<span class="org-string">"role"</span> =&gt; <span class="org-string">"user"</span>, <span class="org-string">"content"</span> =&gt; <span class="org-string">"Can you show me how to make a POST request with the HTTP library?"</span>)]

body = json(Dict(<span class="org-string">"model"</span> =&gt; <span class="org-string">"gpt-3.5-turbo"</span>,
                 <span class="org-string">"messages"</span> =&gt; messages))

response = HTTP.post(
    <span class="org-string">"https://api.openai.com/v1/chat/completions"</span>,
    headers,
    body;
    verbose = <span class="org-constant">false</span>,
)

<span class="org-comment-delimiter"># </span><span class="org-comment">Parse the response body as JSON</span>
result = JSON.parse(String(response.body))
print(result[<span class="org-string">"choices"</span>][1][<span class="org-string">"message"</span>][<span class="org-string">"content"</span>])
</pre>
</div>

<pre class="example" id="org22aeafc">

```julia
using HTTP

# URL to POST to
url = "https://httpbin.org/post"

# Data to include in the POST request (in JSON format)
data = Dict("name" =&gt; "John", "age" =&gt; 30)
json_data = JSON.json(data)

# Headers to specify that we're sending JSON data
headers = Dict("Content-Type" =&gt; "application/json")

# Make the POST request
response = HTTP.request("POST", url, headers, json_data)

# Get the response body as a string
body = String(response.body)

# Print the response status code and body
println("Status code: $(response.status)")
println("Response body: $body")
```

In this example, we're sending a JSON object with a name and age property to https://httpbin.org/post, which is an HTTP testing service. The `headers` argument specifies that we're sending JSON data, while the `json_data` argument is the actual data we want to send.

The `HTTP.request` function is called with the POST method, the URL to POST to, the headers we want to send, and the data we want to include. The response is then captured in the `response` variable.

Finally, we extract the body of the response as a string using `String(response.body)`, and print both the status code and response body to the console.Yes, I can. Here's an example code snippet that shows how to make a POST request using the HTTP library in Julia:

```julia
using HTTP

url = "https://jsonplaceholder.typicode.com/posts"
data = "{\"title\":\"foo\",\"body\":\"bar\",\"userId\":1}"

response = HTTP.post(url, data, ["Content-Type" =&gt; "application/json"])
println(String(response.body))
```

In this example, we first specify the url of the endpoint we want to send our request to. Next, we create a string representation of the JSON data we want to send in our request. We use `HTTP.post()` to send a POST request to the specified url, including the JSON data in the request body, and with a content type header that specifies that the data is JSON (application/json). Finally, we print the response contents converted to a string by the `String()` function.
</pre>

<p>
And if we want to send a followup referring to an earlier part in the conversation, we can extend the <code>messages</code> array as follows:
</p>

<div class="org-src-container">
<pre class="src src-julia"><span class="org-comment-delimiter"># </span><span class="org-comment">include the assistant's previous response</span>
push!(messages, result[<span class="org-string">"choices"</span>][1][<span class="org-string">"message"</span>])

<span class="org-comment-delimiter"># </span><span class="org-comment">ask a new question referring to an earlier part of the conversation</span>
push!(messages, Dict(<span class="org-string">"role"</span> =&gt; <span class="org-string">"user"</span>,
                     <span class="org-string">"content"</span> =&gt; <span class="org-string">"Can you please provide a shorter, simpler example?"</span>))

</pre>
</div>

<pre class="example">
4-element Vector{Dict{String, String}}:
 Dict("role" =&gt; "system", "content" =&gt; "You are a knowledgable and helpful Julia developer.")
 Dict("role" =&gt; "user", "content" =&gt; "Can you show me how to make a POST request with the HTTP library?")
 Dict("role" =&gt; "assistant", "content" =&gt; "Yes, I can. Here's an example code snippet that shows how to make a POST request using the HTTP library in Julia:\n\n```julia\nusing HTTP\n\nurl = \"https://jsonplaceholder.typicode.com/posts\"\ndata = \"{\\\"title\\\":\\\"foo\\\",\\\"body\\\":\\\"bar\\\",\\\"userId\\\":1}\"\n\nresponse = HTTP.post(url, data, [\"Content-Type\" =&gt; \"application/json\"])\nprintln(String(response.body))\n```\n\nIn this example, we first specify the url of the endpoint we want to send our request to. Next, we create a string representation of the JSON data we want to send in our request. We use `HTTP.post()` to send a POST request to the specified url, including the JSON data in the request body, and with a content type header that specifies that the data is JSON (application/json). Finally, we print the response contents converted to a string by the `String()` function.")
 Dict("role" =&gt; "user", "content" =&gt; "Can you please provide a shorter, simpler example?")
</pre>


<p>
And then request another response:
</p>

<div class="org-src-container">
<pre class="src src-julia">body = json(Dict(<span class="org-string">"model"</span> =&gt; <span class="org-string">"gpt-3.5-turbo"</span>,
                 <span class="org-string">"messages"</span> =&gt; messages))

response = HTTP.post(
    <span class="org-string">"https://api.openai.com/v1/chat/completions"</span>,
    headers,
    body;
    verbose = <span class="org-constant">false</span>,
)

<span class="org-comment-delimiter"># </span><span class="org-comment">Parse the response body as JSON</span>
result = JSON.parse(String(response.body))
print(result[<span class="org-string">"choices"</span>][1][<span class="org-string">"message"</span>][<span class="org-string">"content"</span>])
</pre>
</div>

<pre class="example" id="orga6e6c76">
Sure, here's a simpler example:

```julia
using HTTP

url = "https://jsonplaceholder.typicode.com/posts"

response = HTTP.post(url, form = [("title", "foo"), ("body", "bar"), ("userId", "1")])
println(String(response.body))
```

In this example, we are sending a POST request with form data rather than JSON data. We specify the form data using an array of tuples with the keys and values for the form fields. Note that we use the `form` argument to pass the form data to `HTTP.post()`. The response is then printed in the same way as before.
</pre>
</div>
</div>
<div id="outline-container-orgfa5d55e" class="outline-2">
<h2 id="orgfa5d55e">Next Up&#x2026;</h2>
<div class="outline-text-2" id="text-orgfa5d55e">
<p>
This post showed basic usage of the ChatGPT API with Julia. In the next post,
I'll show how to make this more modular and useful. We'll create a <code>Struct</code> for
conversations and a function to call on the API based on the conversation
history in that <code>Struct</code>. After that, I'll write about how to make it interactive,
perhaps as a Julia REPL mode, but at least as a command line utility.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2023-03-04 Sat 00:00</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
