<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>YASnippet for Prompt Templates for Chatgpt-Shell</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<link rel="stylesheet" type="text/css" href="/orgstyle.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap" rel="stylesheet">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@dliden">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<hr style="border-top: 1px solid black;">
<div class='topnav' style='display: flex; justify-content: space-between; align-items: center;'>
  <h2 style='margin-top: 0; margin-bottom: 0; margin-left:0px;'>Daniel Liden</h2> 
  <div>
    <a href='/index.html' style='font-weight:bold; font-style:italic;'>Home</a> /
    <a href='/archive.html' style='font-weight:bold; font-style:italic;'>Blog</a> / 
    <a href='/about.html' style='font-weight:bold; font-style:italic;'>About Me</a> /
    <a href='/photos.html' style='font-weight:bold; font-style:italic;'>Photos</a> /
    <a href='/fine-tuning/' style='font-weight:bold; font-style:italic;'>LLM Fine Tuning</a> /
    <a href='/rss.xml'>
      <img src='/rss.png' style='height: 1em;'>
    </a>
  </div>
</div>
<hr style="border-top: 1px solid black;">
</div>
<div id="content">
<header>
<h1 class="title">YASnippet for Prompt Templates for Chatgpt-Shell</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcd53596">Introduction</a></li>
<li><a href="#org42cda9f">Setting up ChatGPT Shell</a></li>
<li><a href="#orgdbc328e">YASnippet</a>
<ul>
<li><a href="#org78b2dc1">Defining a Snippet</a></li>
<li><a href="#org554685c">Using a Snippet</a></li>
<li><a href="#orgedc2ddb">Inserting the Last Item in the Kill Ring</a></li>
</ul>
</li>
<li><a href="#orgb93042b">Next Steps</a></li>
</ul>
</div>
</nav>
<div id="outline-container-orgcd53596" class="outline-2">
<h2 id="orgcd53596">Introduction</h2>
<div class="outline-text-2" id="text-orgcd53596">
<div class="preview">
<p>
The wonderful <a href="https://github.com/xenodium/chatgpt-shell">chatgpt-shell</a> package by <a href="https://github.com/xenodium">Xenodium</a> lets you interact with the gpt-3.5 and gpt-4
APIs in emacs via a handy shell built on top of <code>comint-mode</code>. It also integrates
well with <code>org-mode</code>.
</p>

<p>
I find that I tend to re-use a few prompt patterns for specific tasks. Yasnippet provides a great
way to create prompt <i>templates</i> made up of some fixed component with placeholders
for user input. I can easily insert these prompt templates when working with
<code>chatgpt-shell</code> to gain easy access to reusable, task-specific prompts. This post
describes how to start using Yasnippet for prompt templates for use with
<code>chatgpt-shell</code>.
</p>

</div>
</div>
</div>
<div id="outline-container-org42cda9f" class="outline-2">
<h2 id="org42cda9f">Setting up ChatGPT Shell</h2>
<div class="outline-text-2" id="text-org42cda9f">
<p>
First of all, if you haven't already tried <code>chatgpt-shell</code>, it's worth taking a
few minutes to set up and try out. If you live in emacs, you'll probably prefer
<code>chatgpt-shell</code> to the chatgpt web interface.
</p>

<p>
You can find the installation instructions <a href="https://github.com/xenodium/chatgpt-shell#install">here</a>. I use straight.el for package
management, and here is my configuration:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package shell-maker
  <span class="org-builtin">:straight</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"xenodium/chatgpt-shell"</span> <span class="org-builtin">:files</span> (<span class="org-string">"shell-maker.el"</span>)
                   <span class="org-builtin">:branch</span> <span class="org-string">"main"</span>))

(use-package chatgpt-shell
  <span class="org-builtin">:after</span> (shell-maker)
  <span class="org-builtin">:straight</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"xenodium/chatgpt-shell"</span> <span class="org-builtin">:files</span> (<span class="org-string">"chatgpt-shell.el"</span>)
                   <span class="org-builtin">:branch</span> <span class="org-string">"main"</span>)
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> chatgpt-shell-openai-key
      (<span class="org-keyword">lambda</span> ()
        (auth-source-pick-first-password <span class="org-builtin">:host</span> <span class="org-string">"api.openai.com"</span>))))

(use-package ob-chatgpt-shell
  <span class="org-builtin">:straight</span> (<span class="org-builtin">:host</span> github <span class="org-builtin">:repo</span> <span class="org-string">"xenodium/chatgpt-shell"</span> <span class="org-builtin">:files</span> (<span class="org-string">"ob-chatgpt-shell.el"</span>)
                   <span class="org-builtin">:branch</span> <span class="org-string">"main"</span>)
  <span class="org-builtin">:ensure</span> t )
</pre>
</div>

<p>
<code>chatgpt-shell</code> is built on <code>shell-maker</code>, which is "a way to create shells for any
service (local or cloud)." <code>ob-chatgpt-shell</code> provides a way to interact with
<code>chatgpt-shell</code> via org babel source blocks. For more details on these, read the
<a href="https://github.com/xenodium/chatgpt-shell">documentation</a> (and consider <a href="https://github.com/sponsors/xenodium">sponsoring</a> Xenodium).
</p>
</div>
</div>
<div id="outline-container-orgdbc328e" class="outline-2">
<h2 id="orgdbc328e">YASnippet</h2>
<div class="outline-text-2" id="text-orgdbc328e">
<p>
<a href="https://github.com/joaotavora/yasnippet">YASnippet</a> is a template system for emacs. It is very powerful, and I'm only
familiar with a small fraction of its capabilities. But when I work with
ChatGPT in other systems, I almost always use some form of templating
system. What does that mean? Suppose I'm working on some kind of text
summarization system. On the one hand, I could write a bunch of separate prompts
of the form:
</p>

<blockquote>
<p>
Summarize the following text:
&lt;some text&gt;
</p>

<p>
Summarize the following text:
&lt;some more text&gt;
</p>

<p>
Summarize the following text:
&lt;even more text&gt;
</p>
</blockquote>

<p>
But the instruction, "Summarize the following text," is the same each time. So
I'd rather put that in a template, which I can fill in as many times as needed
with the part of the prompt that actually changes: the prompt to summarize.
</p>

<p>
This might look like:
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">
(<span class="org-keyword">defun</span> <span class="org-function-name">summary_template</span> (text_to_summarize)
  (<span class="org-keyword">interactive</span> <span class="org-string">"sText to Summarize: "</span>)
  (concat <span class="org-string">"Summarize the following text:\n"</span> text_to_summarize))

(print (summary_template <span class="org-string">"Some text"</span>))
(print (summary_template <span class="org-string">"Some more text"</span>))
(print (summary_template <span class="org-string">"Even more text"</span>))
</pre>
</div>

<pre class="example">

"Summarize the following text:
Some text"

"Summarize the following text:
Some more text"

"Summarize the following text:
Even more text"
</pre>


<p>
YASnippet provides an easy way for us to define and populate templates for use
in <code>chatgpt-shell</code> buffers.
</p>
</div>
<div id="outline-container-org78b2dc1" class="outline-3">
<h3 id="org78b2dc1">Defining a Snippet</h3>
<div class="outline-text-3" id="text-org78b2dc1">
<p>
First, you'll need to <a href="https://github.com/joaotavora/yasnippet/blob/master/README.mdown#installation">install YASnippet</a>.
</p>

<p>
We can define a new snippet with <code>M-x yas-new-snippet</code>. This will open a new
buffer for defining out snippet.
</p>

<div class="org-center">

<figure>
<img src="./figures/20230709-yasnippet-chatgpt-shell/yas-new-snippet.png" alt="yas-new-snippet.png">

<figcaption><span class="figure-number">Figure 1: </span>YASnippet new snippet interface</figcaption>
</figure>
</div>

<p>
In this example, I'm only going to show how to make templates with text and
placeholders. YASnippet is incredibly powerful and supports highly complex
templates; <a href="https://joaotavora.github.io/yasnippet/">read the documentation</a> if you want to explore further. For now, let's
just replicate the summarization template.
</p>

<p>
We'll mostly use <i>tab stop fields</i> and <i>placeholder fields</i> when building our
templates. You can read more about them, and about more advanced templating,
<a href="https://joaotavora.github.io/yasnippet/snippet-development.html">here</a>.
</p>

<p>
Here's what a summarization snippet might look like:
</p>

<pre class="example">
# -*- mode: snippet -*-
# name: Concise Summary
# key: gptsum
# contributor: Daniel Liden
# --
&lt;text&gt;$1&lt;/text&gt;

Provide a concise summary of the above text within &lt;text&gt; tags.
$0
</pre>

<p>
The <code>$1</code> and <code>$0</code> are called <i>tab stop fields</i>. When inserting the snippet with
e.g. <code>yas-insert-snippet</code> or by triggering <a href="https://joaotavora.github.io/yasnippet/snippet-expansion.html">snippet expansion</a>, you can
interactively <code>TAB</code> and <code>S-TAB</code> back and forth through the various tab stop fields,
filling them in with whatever you want. In this case, you could type/yank a text
to summarize in the <code>$1</code> position.
</p>

<p>
<code>$0</code> has a special meaning: it is the <i>exit point</i>, the place the cursor ends up
after completing all of the other tab stop fields.
</p>

<p>
If you want a default value for a given completion field, you can use a
<i>placeholder</i>, which is formatted as <code>${N:default value}</code>. We might modify the above
snippet, for example, to say:
</p>

<pre class="example">
# -*- mode: snippet -*-
# name: Concise Summary
# key: gptsum
# contributor: Daniel Liden
# --
&lt;text&gt;${1:The user forgot to include text to summarize. Remind them!}&lt;/text&gt;

Provide a concise summary of the above text within &lt;text&gt; tags.
$0
</pre>

<p>
Once you've defined the snippet in the <code>yas-new-snippet</code> buffer, you can save it
with <code>C-c C-c</code>. You will then be prompted to choose a "table." This essentially
means specifying the emacs mode with which you'd like the snippet to be
associated. In this case, for <code>chatgpt-shell</code>, it's <code>chatgpt-shell-mode</code>. Specifying
the mode ensures the snippet will be available when you're in
<code>chatgpt-shell-mode</code>. You will also be asked whether you want to save the snippet;
go ahead and do so if you intend to use it in the future.
</p>

<p>
To modify a snippet, you can use <code>yas-visit-snippet-file</code>, make changes, and again
go through the saving dialogue with <code>C-c C-c</code>.
</p>
</div>
</div>

<div id="outline-container-org554685c" class="outline-3">
<h3 id="org554685c">Using a Snippet</h3>
<div class="outline-text-3" id="text-org554685c">
<p>
Note that, in the example snippets above, I've defined a <code>key</code>: this is for
<a href="https://joaotavora.github.io/yasnippet/snippet-expansion.html">snippet expansion</a> (follow the link for more details). With my configuration, in
a <code>chatgpt-shell-mode</code> buffer, I can type <code>gptsum</code> followed by <code>TAB</code> to insert this
snippet. Alternately, I can select from all available snippets with <code>M-x
yas-insert-snippet</code>.
</p>

<p>
Upon inserting the snippet, my cursor will be at the first tab stop. I can then
insert whatever text I want. Upon hitting <code>TAB</code>, the cursor will jump to the next
tab stop. In this case, there was only one, so the cursor will jump to the <code>$0</code>
position at the end of the prompt.
</p>

<div class="org-center">

<figure>
<img src="./figures/20230709-yasnippet-chatgpt-shell/text_summarize_snippet.gif" alt="text_summarize_snippet.gif">

<figcaption><span class="figure-number">Figure 2: </span>Inserting a Snippet</figcaption>
</figure>
</div>

<p>
With multiple tab stops (e.g. <code>$1</code>, <code>$2</code>, etc.), pressing <code>TAB</code> multiple times would
move forward through each position, allowing you to fill in the desired
text. <code>S-TAB</code> enables you to move backward through the tab stops.
</p>
</div>
</div>
<div id="outline-container-orgedc2ddb" class="outline-3">
<h3 id="orgedc2ddb">Inserting the Last Item in the Kill Ring</h3>
<div class="outline-text-3" id="text-orgedc2ddb">
<p>
We're unlike to ever need to summarize text that we manually type into a
<code>chatgpt-shell</code>. But we might want to copy some text to the kill ring and ask for
a summary, or copy some code and ask for an explanation. We can write a template
to accomplish this.
</p>

<p>
We'll use one more advanced feature of <code>YASnippet</code> to accomplish this: we can
embed Emacs-lisp code in a snippet by enclosing it in backticks (<code>``</code>).
</p>

<p>
Here's a snippet for explaining code by pasting (yanking) the most recent text
from the kill ring:
</p>

<pre class="example">
# key: gptce
# name: code-explainer
# --
Explain the following code:
`(yank)`

In particular:
- Step-by-step, what does it do?
- What are the parameters?
- Are there any other noteworthy features of this code?

Answer concisely.
$0
</pre>

<p>
To use this template, you would first copy or kill some code from a buffer, then
navigate to your <code>chatgpt-shell</code> buffer, then insert the snippet. The <code>`(yank)`</code>
part will automatically be replaced by the copied code.
</p>



<div class="org-center">

<figure>
<img src="./figures/20230709-yasnippet-chatgpt-shell/code_explain.gif" alt="code_explain.gif">

<figcaption><span class="figure-number">Figure 3: </span>Inserting from the Kill Ring</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb93042b" class="outline-2">
<h2 id="orgb93042b">Next Steps</h2>
<div class="outline-text-2" id="text-orgb93042b">
<p>
There's a lot more to explore here. YASnippet is a very powerful templating
system, and I've only scratched the surface of the ways to use it for developing
useful prompt templates for <code>chatgpt-shell</code> (and I haven't tried any for the org
babel integration yet). Read the YASnippet manual, write some new snippets, and
let me know what you come up with!
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2023-07-09 Sun 00:00</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.3)</p>
</div>
</body>
</html>
