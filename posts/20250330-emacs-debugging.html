<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emacs Introspection and Debugging</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/org-base.css"/>
<link rel="stylesheet" type="text/css" href="/orgstyle.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@dliden">
<link rel="alternate" type="application/rss+xml" title="Daniel Liden's Blog" href="/rss.xml">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/dark-mode.js" defer></script>
<script src="/admonitions.js" defer></script>
<link rel="canonical" href="https://danliden.com/posts/20250330-emacs-debugging.html">
<meta name="author" content="Daniel Liden">
<meta property="og:url" content="https://danliden.com/posts/20250330-emacs-debugging.html">
<meta property="og:title" content="Emacs Introspection and Debugging">
<meta property="og:description" content="If you use Emacs, you will eventually run into errors. Maybe a recent package update introduced some new issues with your system. Or some custom elisp you wrote runs into an edge case. Regardless o...">
<meta property="og:site_name" content="Daniel Liden">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-03-23T00:00:00Z">
<meta property="article:modified_time" content="2025-10-02T14:22:16Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Emacs Introspection and Debugging">
<meta name="twitter:description" content="If you use Emacs, you will eventually run into errors. Maybe a recent package update introduced some new issues with your system. Or some custom elisp you wrote runs into an edge case. Regardless o...">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Emacs Introspection and Debugging","description":"If you use Emacs, you will eventually run into errors. Maybe a recent package update introduced some new issues with your system. Or some custom elisp you wrote runs into an edge case. Regardless o...","mainEntityOfPage":{"@type":"WebPage","@id":"https://danliden.com/posts/20250330-emacs-debugging.html"},"author":{"@type":"Person","name":"Daniel Liden"},"datePublished":"2025-03-23T00:00:00Z","dateModified":"2025-10-02T14:22:16Z"}</script>
</head>
<body>
<div id="preamble" class="status">
<hr class="topnav-rule">
<header class="site-header">
  <a href="/index.html" class="site-header__brand">
    <h2>Daniel Liden</h2>
  </a>
  <nav class="topnav-links" aria-label="Primary">
    <a href="/archive.html">Blog</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/about.html">About Me</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/photos.html">Photos</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/notebooks/">Notebooks</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/notes.html">Notes</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a class="topnav-icon" href="/rss.xml" aria-label="RSS feed">
      <svg class="rss-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 4h1a14 14 0 0 1 14 14v1"/>
        <path d="M5 11h1a7 7 0 0 1 7 7v1"/>
        <circle cx="6" cy="18" r="2"/>
      </svg>
    </a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <button id="theme-toggle" class="nav-theme-toggle topnav-icon" type="button" aria-label="Switch to dark mode" aria-pressed="false">
      <svg class="theme-icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/>
      </svg>
    </button>
  </nav>
</header>
<hr class="topnav-rule">
</div>
<div id="content" class="content">
<header>
<h1 class="title">Emacs Introspection and Debugging</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgd33ca78">Introduction</a></li>
<li><a href="#orge95a4a1">Finding Relevant Variables</a></li>
<li><a href="#org32b4f2a">Confirming the issue with error backtrace</a></li>
<li><a href="#org40523b6">Quick fix—bandaid approach</a></li>
<li><a href="#org12a8442">Finding the root of the problem</a></li>
<li><a href="#org5d2e984">Conclusion—Emacs introspection</a></li>
</ul>
</div>
</nav>
<div class="preview" id="org1556390">
<p>
If you use Emacs, you will eventually run into errors. Maybe a recent package update introduced some new issues with your system. Or some custom elisp you wrote runs into an edge case. Regardless of the cause, Emacs provides many tools for identifying the causes of errors and learning how to address them.
</p>

<p>
This post works through a recent issue I encountered with the <code>eglot</code> package and how I was able to identify and fix the issue using various introspection tools built into Emacs. It provides some general advice for how to use Emacs to learn about and debug issues with Emacs.
</p>

</div>

<div id="outline-container-orgd33ca78" class="outline-2">
<h2 id="orgd33ca78">Introduction</h2>
<div class="outline-text-2" id="text-orgd33ca78">
<p>
For a while, whenever I used <a href="https://www.gnu.org/software/emacs/manual/html_mono/eglot.html">eglot</a> (mostly for Python projects) and then shut it down with e.g. <code>M-x eglot-shutdown</code>, all subsequent attempts to save any files in Emacs would return the following error: <code>(jsonrpc-error-message . "No current JSON-RPC connection")</code>. The save would generally succeed, so this was more annoying than anything. But it <i>was</i> annoying.
</p>

<p>
Some quick searching online did not yield any useful discussions of how to fix the issue. And neither Claude nor Perplexity had much to offer, either. So I decided to use this as an excuse to learn more about built-in Emacs introspection and debugging tools.
</p>

<p>
I went in with the following information:
</p>
<ol class="org-ol">
<li>The issue was related to <code>eglot</code>. Even though the error message did not reference eglot, the issue consistently appeared after using eglot and then shutting it down.</li>
<li>The issue was triggered when I saved files.</li>
</ol>

<p>
Given this pattern, I started by looking for <a href="https://www.danliden.com/posts/20231217-emacs-hooks.html">hooks</a> related to saving.
</p>
</div>
</div>
<div id="outline-container-orge95a4a1" class="outline-2">
<h2 id="orge95a4a1">Finding Relevant Variables</h2>
<div class="outline-text-2" id="text-orge95a4a1">
<p>
I wasn't entirely sure what I was looking for. But I knew from previous reading that hooks are variables that, by convention, include the word <code>hook</code> in their names. This already provides plenty to work with.
</p>

<p>
The <code>apropos-variable</code> function takes a pattern or a list of words and returns an <code>*Apropos*</code> buffer with a list of matching variables. In this case, I interactively used <code>apropos-variable</code> with <code>M-x apropos-variable RET save hook</code> to search for variables matching <code>save</code> and <code>hook</code>. This returned a couple of good candidates for further exploration!
</p>


<figure id="org75940d5">
<img src="./figures/20250323-emacs-debugging/1_apropos.png" alt="1_apropos.png">

</figure>

<p>
The <code>after-save-hook</code> and <code>before-save-hook</code> variables look especially promising. We can inspect those further for anything <code>eglot</code>-related by selecting them from the <code>*Apropos*</code> buffer or searching for them with <code>C-h v &lt;variable-name&gt;</code>. Following this approach showed me that:
</p>

<ol class="org-ol">
<li>The value of <code>before-save-hook</code> is <code>nil</code>.</li>
<li>The value of <code>after-save-hook</code> is <code>(eglot-format)</code>.</li>
</ol>

<p>
This is already very useful and points toward some directions for fixing the issue! <code>after-save-hook</code> is a "Normal hook that is run after a buffer is saved to its file." This would explain why (1) the issue is associated with saving files and (2) the saves are successful in spite of the error (the hook is run <i>after</i> the save, not before).
</p>
</div>
</div>
<div id="outline-container-org32b4f2a" class="outline-2">
<h2 id="org32b4f2a">Confirming the issue with error backtrace</h2>
<div class="outline-text-2" id="text-org32b4f2a">
<p>
I wanted to confirm that this hook was causing the issue so I used <code>M-x toggle-debug-on-error</code> to get a more detailed backtrace. In reality, this is where I should have started—the error trace provides much more specific and useful information than the short error message returned in the echo area. When I tried to save a file with debugging enabled, I received the following in a <b>Backtrace</b> buffer.
</p>

<pre class="example">
Debugger entered--Lisp error: (jsonrpc-error "No current JSON-RPC connection" (jsonrpc-error-code . -32603) (jsonrpc-error-message . "No current JSON-RPC connection"))
  jsonrpc-error("No current JSON-RPC connection")
  eglot--current-server-or-lose()
  eglot-server-capable(:documentFormattingProvider)
  eglot-server-capable-or-lose(:documentFormattingProvider)
  eglot-format()
  run-hooks(after-save-hook)
  #&lt;subr basic-save-buffer&gt;(t)
  polymode-with-current-base-buffer(#&lt;subr basic-save-buffer&gt; t)
  apply(polymode-with-current-base-buffer #&lt;subr basic-save-buffer&gt; t)
  basic-save-buffer(t)
  save-buffer(1)
  funcall-interactively(save-buffer 1)
  command-execute(save-buffer)
</pre>


<p>
You can read this backtrace from bottom to top. After saving the buffer, we see that <code>run-hooks(after-save-hook)</code> runs, which results in <code>eglot-format()</code> being run. The final function called before the error is <code>eglot--current-server-or-lose()</code>. Inspecting this with <code>C-h f RET eglot--current-server-or-lose</code> tells us that this function returns the "current logical Eglot server connection or error." If I'm saving some random file that is not going to use a Python LSP server, we would expect this to return an error.
</p>

<p>
Now that we have some understanding of what is happening, how do we fix it?
</p>
</div>
</div>
<div id="outline-container-org40523b6" class="outline-2">
<h2 id="org40523b6">Quick fix—bandaid approach</h2>
<div class="outline-text-2" id="text-org40523b6">
<p>
My initial fix for this issue was to write a simple cleanup script to remove the offending hook function from the <code>after-save-hook</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">use-package</span> eglot
  <span class="org-builtin">:straight</span>
  (<span class="org-builtin">:type</span> built-in)
  <span class="org-builtin">:hook</span> ((python-mode . eglot-ensure))
  <span class="org-builtin">:config</span>
  (<span class="org-keyword">setq</span> eglot-autoshutdown t)
  
  (<span class="org-keyword">defun</span> <span class="org-function-name">my-eglot-shutdown-cleanup</span> (<span class="org-type">&amp;rest</span> _)
    <span class="org-doc">"Perform thorough cleanup after Eglot shutdown."</span>
    (remove-hook 'after-save-hook #'eglot-format nil)
  (advice-add 'eglot-shutdown <span class="org-builtin">:after</span> #'my-eglot-shutdown-cleanup))
</pre>
</div>

<p>
This isn't perfect. It <i>does</i> prevent saving from returning an error <i>after</i> I've shut down eglot, resolving a significant nuisance. However, the issue remains when eglot is running and I try to save a buffer without an associated LSP server; i.e., if I am using eglot in a Python buffer but then try to save an org buffer. The <code>eglot-format</code> hook function is still active; there is no running language server to provide formatting for org buffers, so the hook function returns an error.
</p>

<p>
At this point, it was not yet clear to me how the hook was set in the first place. Deactivating the hook when eglot is not running resolves about 80% of the frustration for me. But I <b>would</b> like to fully resolve the issue. I don't actually <i>want</i> the format-on-save behavior in the first place. It has to be set <b>somewhere</b>. In the next section, I will briefly sketch out my process for identifying the issue.
</p>
</div>
</div>

<div id="outline-container-org12a8442" class="outline-2">
<h2 id="org12a8442">Finding the root of the problem</h2>
<div class="outline-text-2" id="text-org12a8442">
<p>
My first thought was that, perhaps, the hook was being set when <code>eglot</code> was invoked. To check this, I:
</p>
<ol class="org-ol">
<li>Called <code>C-h f eglot</code> to find the documentation for the <code>eglot</code> command</li>
<li>Followed the link in the help buffer to <code>eglot.el</code>, the source file where the <code>eglot</code> command and related functions are defined.</li>
<li>Used <code>consult-line</code> (or, equivalently, <code>isearch</code> or one of the many other tools available for searching buffer text) for the term <code>hook</code>.</li>
</ol>

<p>
This showed me that <code>eglot-format</code> was not, in fact, being set as an <code>after-save-hook</code> function by eglot itself.
</p>

<p>
So&#x2026;did I do this myself, somewhere in my config?
</p>

<p>
I next navigated to my config folder, <code>~/coffeemacs/</code>, and invoked <code>lgrep</code> to search my various <code>*.el</code> config files for anything related to <code>eglot</code>.
</p>

<p>
And it turns out, I set this hook myself!
</p>



<figure id="orgb327da3">
<img src="./figures/20250323-emacs-debugging/2_grep.png" alt="2_grep.png">

</figure>

<p>
Once I deleted the <code>(add-hook 'after-save-hook ...)</code> call from my config, the issue was fully resolved.
</p>
</div>
</div>

<div id="outline-container-org5d2e984" class="outline-2">
<h2 id="org5d2e984">Conclusion—Emacs introspection</h2>
<div class="outline-text-2" id="text-org5d2e984">
<p>
The approaches I used here are nowhere close to comprehensive. Emacs has countless introspection tools and a seemingly-inexhaustible collection of functions and variables that enable you to inspect everything going on in your Emacs setup. Furthermore, it provides a range of ways to search these variables and functions.
</p>

<p>
The following tools will go a long way toward helping you debug an error in Emacs:
</p>

<ol class="org-ol">
<li><b>Enable debugging on error</b> with <code>M-x toggle-debug-on-error</code>. This will provide a backtrace that will show the source of the error.</li>
<li><b>Search for relevant functions and variables</b> with <code>apropos-function</code> and <code>apropos-variable</code>. You can pass in a list of relevant terms to search for.</li>
<li><b>Get documentation for specific functions and variables</b> with the <code>describe-function</code> (<code>C-h f</code>) and <code>describe-variable</code> (<code>C-h v</code>) commands.</li>
</ol>

<p>
Even these relatively simple tools are often enough to identify the source of an issue and do something about it.
</p>

<p>
Lastly—we're reaching a point where you don't have to do this yourself. You can configure the <a href="https://github.com/karthink/gptel?tab=readme-ov-file#i-want-the-window-to-scroll-automatically-as-the-response-is-inserted">gptel</a> package with a set of tools—Emacs functions—that will enable it to recursively search for information in docs, manuals, source code, etc. <a href="https://youtu.be/JHXG225oP8E?si=6pgmR_S-Vk2QmjU9">This video</a> provides a good overview of how to get started.
</p>


<figure id="org363f435">
<img src="./figures/20250323-emacs-debugging/3_gptel.png" alt="3_gptel.png">

</figure>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2025-03-23 Sun 00:00</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
