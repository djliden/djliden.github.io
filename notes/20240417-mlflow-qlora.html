<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Logging and Loading a QLoRA Model with MLflow</title>
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/org-base.css"/>
<link rel="stylesheet" type="text/css" href="/orgstyle.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="me" href="https://emacs.ch/@dliden">
<link rel="alternate" type="application/rss+xml" title="Daniel Liden's Blog" href="/rss.xml">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/dark-mode.js" defer></script>
<script src="/admonitions.js" defer></script>
<link rel="canonical" href="https://danliden.com/notes/20240417-mlflow-qlora.html">
<meta name="author" content="Daniel Liden">
<meta property="og:url" content="https://danliden.com/notes/20240417-mlflow-qlora.html">
<meta property="og:title" content="Logging and Loading a QLoRA Model with MLflow">
<meta property="og:description" content="This is a minimal example of how to log an MLflow qlora model. It does not show any actual model training or data processing, just the basic process of saving the model.">
<meta property="og:site_name" content="Daniel Liden">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-04-17T00:00:00Z">
<meta property="article:modified_time" content="2025-10-01T22:46:52Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Logging and Loading a QLoRA Model with MLflow">
<meta name="twitter:description" content="This is a minimal example of how to log an MLflow qlora model. It does not show any actual model training or data processing, just the basic process of saving the model.">
<script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Logging and Loading a QLoRA Model with MLflow","description":"This is a minimal example of how to log an MLflow qlora model. It does not show any actual model training or data processing, just the basic process of saving the model.","mainEntityOfPage":{"@type":"WebPage","@id":"https://danliden.com/notes/20240417-mlflow-qlora.html"},"author":{"@type":"Person","name":"Daniel Liden"},"datePublished":"2024-04-17T00:00:00Z","dateModified":"2025-10-01T22:46:52Z"}</script>
</head>
<body>
<div id="preamble" class="status">
<hr class="topnav-rule">
<header class="site-header">
  <a href="/index.html" class="site-header__brand">
    <h2>Daniel Liden</h2>
  </a>
  <nav class="topnav-links" aria-label="Primary">
    <a href="/archive.html">Blog</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/about.html">About Me</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/photos.html">Photos</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/notebooks/">Notebooks</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a href="/notes.html">Notes</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a class="topnav-icon" href="/rss.xml" aria-label="RSS feed">
      <svg class="rss-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 4h1a14 14 0 0 1 14 14v1"/>
        <path d="M5 11h1a7 7 0 0 1 7 7v1"/>
        <circle cx="6" cy="18" r="2"/>
      </svg>
    </a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <button id="theme-toggle" class="nav-theme-toggle topnav-icon" type="button" aria-label="Switch to dark mode" aria-pressed="false">
      <svg class="theme-icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/>
      </svg>
    </button>
  </nav>
</header>
<hr class="topnav-rule">
</div>
<div id="content" class="content">
<header>
<h1 class="title">Logging and Loading a QLoRA Model with MLflow</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org4bca8e7">Install Dependencies</a></li>
<li><a href="#orgfc8825c">Set up assets/cache directories</a></li>
<li><a href="#orgf2dbdaf">Skip Data Processing</a></li>
<li><a href="#orgdc8626c">Load the model, tokenizer, etc.</a>
<ul>
<li><a href="#orgc63d9d2">Tokenizer</a></li>
<li><a href="#org03004c6">LoRA config</a></li>
<li><a href="#org5542926">Model</a></li>
<li><a href="#org5d8713d">Set up the peft model</a></li>
</ul>
</li>
<li><a href="#org2ca8725">Skip Training</a></li>
<li><a href="#org80119db">Log to MLflow</a></li>
<li><a href="#org63c7246">Load the MLflow model</a></li>
<li><a href="#org73c3f7b">Summary</a></li>
</ul>
</div>
</nav>
<div class="preview" id="orgee2a348">
<p>
This is a minimal example of how to log an MLflow qlora model. It does not show any actual model training or data processing, just the basic process of saving the model.
</p>

</div>

<div id="outline-container-org4bca8e7" class="outline-2">
<h2 id="org4bca8e7">Install Dependencies</h2>
<div class="outline-text-2" id="text-org4bca8e7">
<div class="org-src-container">
<pre class="src src-python"><span class="org-operator">%</span>pip install <span class="org-operator">--</span>upgrade torch
<span class="org-operator">%</span>pip install <span class="org-operator">--</span>upgrade transformers accelerate peft bitsandbytes mlflow pynvml packaging ninja
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span class="org-operator">%</span>sh
cd <span class="org-operator">/</span>databricks<span class="org-operator">/</span>driver<span class="org-operator">/</span>
git clone https:<span class="org-operator">//</span>github.com<span class="org-operator">/</span>Dao<span class="org-operator">-</span>AILab<span class="org-operator">/</span>flash<span class="org-operator">-</span>attention.git
cd flash<span class="org-operator">-</span>attention
pip install . <span class="org-operator">--</span>no<span class="org-operator">-</span>build<span class="org-operator">-</span>isolation
</pre>
</div>

<p>
(See <a href="20240416-torch-cuda-flash-attn.html">this earlier note</a> for more information on installing flash attention)
</p>
</div>
</div>
<div id="outline-container-orgfc8825c" class="outline-2">
<h2 id="orgfc8825c">Set up assets/cache directories</h2>
<div class="outline-text-2" id="text-orgfc8825c">
<div class="org-src-container">
<pre class="src src-python"><span class="org-comment-delimiter"># </span><span class="org-comment">Some Environment Setup
</span><span class="org-variable-name">ASSETS_DIR</span> <span class="org-operator">=</span> <span class="org-string">"&lt;assets_dir&gt;"</span>
<span class="org-variable-name">OUTPUT_DIR</span> <span class="org-operator">=</span> ASSETS_DIR <span class="org-operator">+</span> <span class="org-string">"/results/mistral_qlora_min/"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">the path to the output directory; where model checkpoints will be saved
</span><span class="org-variable-name">LOG_DIR</span> <span class="org-operator">=</span> ASSETS_DIR <span class="org-operator">+</span> <span class="org-string">"/logs/mistral_qlora_min/"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">the path to the log directory; where logs will be saved
</span><span class="org-variable-name">CACHE_DIR</span> <span class="org-operator">=</span> ASSETS_DIR <span class="org-operator">+</span> <span class="org-string">"/cache/mistral_qlora_min/"</span> <span class="org-comment-delimiter"># </span><span class="org-comment">the path to the cache directory; where cache files will be saved</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf2dbdaf" class="outline-2">
<h2 id="orgf2dbdaf">Skip Data Processing</h2>
<div class="outline-text-2" id="text-orgf2dbdaf">
<p>
We are not preparing or using any training data in this example. We are skipping the training part.
</p>
</div>
</div>
<div id="outline-container-orgdc8626c" class="outline-2">
<h2 id="orgdc8626c">Load the model, tokenizer, etc.</h2>
<div class="outline-text-2" id="text-orgdc8626c">
</div>
<div id="outline-container-orgc63d9d2" class="outline-3">
<h3 id="orgc63d9d2">Tokenizer</h3>
<div class="outline-text-3" id="text-orgc63d9d2">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> transformers <span class="org-keyword">import</span> AutoTokenizer
<span class="org-variable-name">tokenizer</span> <span class="org-operator">=</span> AutoTokenizer.from_pretrained(<span class="org-string">"mistralai/Mistral-7B-v0.1"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org03004c6" class="outline-3">
<h3 id="org03004c6">LoRA config</h3>
<div class="outline-text-3" id="text-org03004c6">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> peft <span class="org-keyword">import</span> LoraConfig, TaskType

<span class="org-variable-name">lora_config</span> <span class="org-operator">=</span> LoraConfig(
    r<span class="org-operator">=</span>64,
    target_modules<span class="org-operator">=</span><span class="org-string">"all-linear"</span>,
    task_type<span class="org-operator">=</span>TaskType.CAUSAL_LM,
    lora_alpha<span class="org-operator">=</span>32,
    lora_dropout<span class="org-operator">=</span>0.05
)
</pre>
</div>
</div>
</div>
<div id="outline-container-org5542926" class="outline-3">
<h3 id="org5542926">Model</h3>
<div class="outline-text-3" id="text-org5542926">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> transformers <span class="org-keyword">import</span> AutoModelForCausalLM, BitsAndBytesConfig
<span class="org-keyword">import</span> torch

<span class="org-variable-name">bnb_config</span> <span class="org-operator">=</span> BitsAndBytesConfig(
    load_in_4bit<span class="org-operator">=</span><span class="org-constant">True</span>,
    <span class="org-comment-delimiter">#</span><span class="org-comment">bnb_4bit_use_double_quant=True,
</span>    bnb_4bit_compute_dtype<span class="org-operator">=</span>torch.bfloat16,
)

<span class="org-variable-name">model</span> <span class="org-operator">=</span> AutoModelForCausalLM.from_pretrained(
    <span class="org-string">"mistralai/Mistral-7B-v0.1"</span>,
    trust_remote_code<span class="org-operator">=</span><span class="org-constant">True</span>,
    cache_dir<span class="org-operator">=</span>CACHE_DIR,
    device_map<span class="org-operator">=</span><span class="org-string">"auto"</span>,
    quantization_config<span class="org-operator">=</span>bnb_config)
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d8713d" class="outline-3">
<h3 id="org5d8713d">Set up the peft model</h3>
<div class="outline-text-3" id="text-org5d8713d">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">from</span> peft <span class="org-keyword">import</span> get_peft_model

<span class="org-comment-delimiter"># </span><span class="org-comment">this results in the peft model type
</span><span class="org-variable-name">Model</span> <span class="org-operator">=</span> get_peft_model(model, lora_config)

<span class="org-comment-delimiter"># </span><span class="org-comment">this does not
</span><span class="org-comment-delimiter"># </span><span class="org-comment">model.add_adapter(lora_config)
</span><span class="org-comment-delimiter"># </span><span class="org-comment">what is the difference?</span>
</pre>
</div>

<p>
<code>Model = get_peft_model(model, lora_config)</code> and <code>model.add_adapter(lora_config)</code> yield different results. The former changes the type of the model to <code>PeftModelForCausalLM</code>; the latter does not.
</p>

<pre class="example">
PeftModelForCausalLM(
  (base_model): LoraModel(
    (model): MistralForCausalLM(
      (model): MistralModel(
        (embed_tokens): Embedding(32000, 4096)
        (layers): ModuleList(
          (0-31): 32 x MistralDecoderLayer(
            (self_attn): MistralSdpaAttention(
              (q_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=4096, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=4096, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (k_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=1024, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=1024, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (v_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=1024, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=1024, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (o_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=4096, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=4096, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (rotary_emb): MistralRotaryEmbedding()
            )
            (mlp): MistralMLP(
              (gate_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=14336, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=14336, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (up_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=4096, out_features=14336, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=4096, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=14336, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (down_proj): lora.Linear4bit(
                (base_layer): Linear4bit(in_features=14336, out_features=4096, bias=False)
                (lora_dropout): ModuleDict(
                  (default): Dropout(p=0.05, inplace=False)
                )
                (lora_A): ModuleDict(
                  (default): Linear(in_features=14336, out_features=64, bias=False)
                )
                (lora_B): ModuleDict(
                  (default): Linear(in_features=64, out_features=4096, bias=False)
                )
                (lora_embedding_A): ParameterDict()
                (lora_embedding_B): ParameterDict()
              )
              (act_fn): SiLU()
            )
            (input_layernorm): MistralRMSNorm()
            (post_attention_layernorm): MistralRMSNorm()
          )
        )
        (norm): MistralRMSNorm()
      )
      (lm_head): Linear(in_features=4096, out_features=32000, bias=False)
    )
  )
)
</pre>

<p>
Though the <code>add_adapter</code> approach does, in fact, add the adapter, it just doesn't change the type. It is not clear to me what the significance of this is in terms of training, inference, MLflow handling, etc.
</p>
</div>
</div>
</div>
<div id="outline-container-org2ca8725" class="outline-2">
<h2 id="org2ca8725">Skip Training</h2>
<div class="outline-text-2" id="text-org2ca8725">
<p>
Again, we are not actually training the model.
</p>
</div>
</div>
<div id="outline-container-org80119db" class="outline-2">
<h2 id="org80119db">Log to MLflow</h2>
<div class="outline-text-2" id="text-org80119db">
<p>
(Not all of this is necessary)
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-variable-name">prompt_template</span> <span class="org-operator">=</span> <span class="org-string">"""&lt;|im_start|&gt;system
You are a helpful assistant and an expert at making coffee.&lt;|im_end|&gt;
&lt;|im_start|&gt;user
{prompt}&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant

"""</span>

<span class="org-keyword">from</span> mlflow.models <span class="org-keyword">import</span> infer_signature

<span class="org-variable-name">prompt_template</span> <span class="org-operator">=</span> <span class="org-string">"""&lt;|im_start|&gt;system
You are a helpful assistant and an expert at making coffee.&lt;|im_end|&gt;
&lt;|im_start|&gt;user
{prompt}&lt;|im_end|&gt;
&lt;|im_start|&gt;assistant

"""</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Define the sample input/output
</span><span class="org-variable-name">sample_input</span> <span class="org-operator">=</span> <span class="org-string">"What is two plus two?"</span>
<span class="org-variable-name">sample_output</span> <span class="org-operator">=</span> prompt_template.<span class="org-builtin">format</span>(prompt<span class="org-operator">=</span>sample_input) <span class="org-operator">+</span> <span class="org-string">"four&lt;|im_end|&gt;</span><span class="org-constant">\n</span><span class="org-string">&lt;|endoftext|&gt;"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Define the sample parameters
</span><span class="org-variable-name">sample_params</span> <span class="org-operator">=</span> {
    <span class="org-string">"max_new_tokens"</span>: 512,
    <span class="org-string">"repetition_penalty"</span>: 1.1,
}

<span class="org-comment-delimiter"># </span><span class="org-comment">MLflow infers schema from the provided sample input/output/params
</span><span class="org-variable-name">signature</span> <span class="org-operator">=</span> infer_signature(
    model_input<span class="org-operator">=</span>sample_input,
    model_output<span class="org-operator">=</span>sample_output,
    params<span class="org-operator">=</span>sample_params,
)

<span class="org-builtin">print</span>(signature)
</pre>
</div>

<p>
#+RESULTS
</p>
<pre class="example">
inputs: 
  [string (required)]
outputs: 
  [string (required)]
params: 
  ['max_new_tokens': long (default: 512), 'repetition_penalty': double (default: 1.1)]
</pre>


<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> mlflow

<span class="org-keyword">with</span> mlflow.start_run():
    mlflow.log_params(lora_config.to_dict())
    mlflow.transformers.log_model(
        transformers_model<span class="org-operator">=</span>{<span class="org-string">"model"</span>: model, <span class="org-string">"tokenizer"</span>: tokenizer},
        signature<span class="org-operator">=</span>signature,
        artifact_path<span class="org-operator">=</span><span class="org-string">"model"</span>,  <span class="org-comment-delimiter"># </span><span class="org-comment">This is a relative path to save model files within MLflow run
</span>        extra_pip_requirements <span class="org-operator">=</span> [<span class="org-string">"bitsandbytes"</span>, <span class="org-string">"peft"</span>],
    )
</pre>
</div>

<p>
Note the message printed at this step:
</p>

<blockquote>
<p>
INFO mlflow.transformers: Overriding save<sub>pretrained</sub> to False for PEFT models, following the Transformers behavior. The PEFT adaptor and config will be saved, but the base model weights will not and reference to the HuggingFace Hub repository will be logged instead.
</p>
</blockquote>

<p>
This is 
</p>
</div>
</div>
<div id="outline-container-org63c7246" class="outline-2">
<h2 id="org63c7246">Load the MLflow model</h2>
<div class="outline-text-2" id="text-org63c7246">
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span> mlflow

<span class="org-variable-name">run_id</span> <span class="org-operator">=</span> <span class="org-string">"&lt;model_id&gt;"</span>
<span class="org-variable-name">mlflow_model</span> <span class="org-operator">=</span> mlflow.pyfunc.load_model(f<span class="org-string">'runs:/</span>{run_id}<span class="org-string">/model'</span>)
</pre>
</div>

<p>
This will load the model. We can then use its predict method.
</p>

<div class="org-src-container">
<pre class="src src-python">mlflow_model.predict(<span class="org-string">"Classify the following as postive, negative, or neutral: 'I had a rotten day!'"</span>)
</pre>
</div>

<p>
Which returns:
</p>

<pre class="example">
"Classify the following as postive, negative, or neutral: 'I had a rotten day!'\n* 10.24 Classify the following as postive, negative, or neutral: 'I'm so happy to see you!'\n* 10.25 Classify the following as postive, negative, or neutral: 'I'm so sorry I was late.'\n* 10.26 Classify the following as postive, negative, or neutral: 'I'm so glad you came.'\n* 10.27 Classify the following as postive, negative, or neutral: 'I'm so sorry I didn't call.'\n* 10.28 Classify the following as postive, negative, or neutral: 'I'm so glad you called.'\n* [...]
</pre>

<p>
because we did not actually fine-tune the model to follow any of our instructions.
</p>
</div>
</div>

<div id="outline-container-org73c3f7b" class="outline-2">
<h2 id="org73c3f7b">Summary</h2>
<div class="outline-text-2" id="text-org73c3f7b">
<p>
This note showed the basics of how to log and load a peft model with MLflow.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2024-04-17 Wed 00:00</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</p>
</div>
</body>
</html>
